<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hệ Thống Xác Nhận Bảo Mật</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #1a1a1a;
            font-family: Arial, sans-serif;
            overflow: hidden;
            color: white;
        }

        /* 1. MÀN HÌNH INTRO */
        #intro-screen {
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            height: 100vh; text-align: center;
        }

        #warning-box {
            width: 150px; height: 150px;
            background-color: red;
            border-radius: 15px;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; font-weight: bold; cursor: pointer;
            transition: 0.5s; margin-bottom: 20px;
        }

        .circle-star {
            border-radius: 50% !important;
            background-color: red !important;
            position: relative;
        }
        .circle-star::after {
            content: '★'; color: yellow; font-size: 80px;
        }

        #code-input-area { display: none; margin-top: 20px; }
        input[type="number"] {
            padding: 10px; font-size: 20px; width: 100px;
            text-align: center; border-radius: 5px; border: none;
        }
        #status-msg { margin-top: 10px; font-weight: bold; }

        /* 2. TRANG CHÍNH */
        #main-page {
            display: none; padding: 20px;
            height: 100vh; overflow-y: auto;
        }

        .info-box {
            background: white; color: black;
            padding: 20px; border-radius: 10px;
            line-height: 1.6; font-size: 16px;
        }

        .btn-sign {
            background: #ff4757; color: white;
            padding: 15px; width: 100%; border: none;
            border-radius: 8px; margin-top: 20px;
            font-size: 18px; font-weight: bold;
        }

        /* 3. Ô KÝ TÊN */
        #sign-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100;
            flex-direction: column;
        }

        #signature-pad { flex-grow: 1; touch-action: none; background: #fff; }

        .sign-controls { display: flex; border-top: 1px solid #ccc; }
        .sign-controls button { flex: 1; padding: 15px; border: none; font-weight: bold; }
        .btn-confirm { background: #2ecc71; color: white; }
        .btn-reset { background: #f1c40f; color: black; }
        .btn-close { background: #e74c3c; color: white; }

        /* 4. MÀN HÌNH THÀNH CÔNG */
        #success-screen {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 200;
            justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div id="warning-box" onclick="handleWarningClick()">18+</div>
        <div id="code-input-area">
            <p>Nhập mã xác nhận:</p>
            <input type="number" id="passcode" placeholder="***" oninput="checkCode()">
            <div id="status-msg"></div>
        </div>
    </div>

    <div id="main-page">
        <div class="info-box" id="content-to-send">
            <h3>THÔNG BÁO NHIỆM VỤ & KÝ TÊN</h3>
            <p>Trong hồ sơ (HS) có tổng cộng 13 bộ. Hiện tại, nếu bạn ký tên thì sẽ ký cho 9 bộ và chỉ còn 4 bộ sau Tết.</p>
            <p>Nếu bạn ký tên 9 bộ này, chúng sẽ được xử lý hủy hoàn toàn và chỉ còn lại 4 bộ quan trọng sau Tết nhé. Hãy suy nghĩ thật kỹ trước khi đặt bút ký tên.</p>
        </div>
        <button class="btn-sign" onclick="openSignPad()">XÁC NHẬN KÝ TÊN</button>
    </div>

    <div id="sign-overlay">
        <canvas id="signature-pad"></canvas>
        <div class="sign-controls">
            <button class="btn-reset" onclick="clearPad()">Xem xét lại</button>
            <button class="btn-confirm" onclick="confirmSign()">Xác nhận ký</button>
            <button class="btn-close" onclick="closeSignPad()">Đóng</button>
        </div>
    </div>

    <div id="success-screen">
        <h1 style="color: #2ecc71;">THÀNH CÔNG</h1>
        <p>Yêu cầu đang chờ hệ thống duyệt.<br>Bạn lưu ý điện thoại để nhận thông báo.</p>
    </div>

    <script>
        // --- CẤU HÌNH EMAILJS (Thay thông tin của bạn vào đây) ---
        const EMAILJS_PUBLIC_KEY = "jEWtLimubhL7xWMC9"; 
        const EMAILJS_SERVICE_ID = "service_a10nxvr";
        const EMAILJS_TEMPLATE_ID = "template_3tnyagg";

        emailjs.init(EMAILJS_PUBLIC_KEY);

        // --- HÀM GỬI EMAIL ---
        function sendEmail(subject, message, signatureImg = "") {
            const templateParams = {
                subject: subject,
                message: message,
                signature_image: signatureImg // Đây là chuỗi Base64 của ảnh chữ ký
            };

            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                .then(() => console.log("Đã gửi báo cáo về Gmail!"))
                .catch((err) => console.error("Lỗi gửi email:", err));
        }

        // --- LOGIC WEB ---
        function handleWarningClick() {
            const box = document.getElementById('warning-box');
            box.style.backgroundColor = '#2ecc71';
            box.innerText = '';
            setTimeout(() => {
                box.classList.add('circle-star');
                document.getElementById('code-input-area').style.display = 'block';
            }, 2000);
        }

        function checkCode() {
            const code = document.getElementById('passcode').value;
            const msg = document.getElementById('status-msg');

            if(code === '006') {
                msg.innerText = 'Đúng mã!';
                msg.style.color = '#2ecc71';
                
                // Gửi thông báo có người vào web
                sendEmail("CẢNH BÁO TRUY CẬP", "Có người vừa nhập đúng mã 006 và vào trang chính.");

                setTimeout(() => {
                    document.getElementById('intro-screen').style.display = 'none';
                    document.getElementById('main-page').style.display = 'block';
                }, 1500);
            } else if (code.length >= 3) {
                msg.innerText = 'Mã sai!';
                msg.style.color = 'red';
            }
        }

        // --- VẼ CHỮ KÝ ---
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function openSignPad() {
            document.getElementById('sign-overlay').style.display = 'flex';
            resizeCanvas();
        }

        function closeSignPad() { document.getElementById('sign-overlay').style.display = 'none'; }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 60;
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left,
                y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top
            };
        }

        function startPosition(e) { isDrawing = true; draw(e); }
        function finishedPosition() { isDrawing = false; ctx.beginPath(); }
        function draw(e) {
            if(!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', startPosition);
        canvas.addEventListener('touchend', finishedPosition);
        canvas.addEventListener('touchmove', draw);

        function clearPad() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        // --- XÁC NHẬN KÝ VÀ GỬI TOÀN BỘ DỮ LIỆU ---
        function confirmSign() {
            // 1. Lấy ảnh chữ ký dạng Base64
            const signatureData = canvas.toDataURL("image/png");
            
            // 2. Lấy nội dung văn bản trong ô thông báo
            const contentText = document.getElementById('content-to-send').innerText;

            // 3. Gửi Email kèm nội dung và ảnh chữ ký
            sendEmail("XÁC NHẬN KÝ TÊN MỚI", "Người dùng đã ký xác nhận nội dung sau:\n\n" + contentText, signatureData);

            // 4. Hiển thị màn hình thành công
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('sign-overlay').style.display = 'none';
            document.getElementById('success-screen').style.display = 'flex';
        }
    </script>
</body>
</html>
